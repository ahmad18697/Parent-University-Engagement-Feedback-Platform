{% extends "base.html" %}
{% block content %}
<section class="card">
  <h2><i class="fas fa-list-check"></i> Feedback Management</h2>
  
  <!-- Filters -->
  <form method="get" action="/feedback" class="filters">
    <label>
      <i class="fas fa-building"></i> Department
      <select name="department">
        <option value="">All Departments</option>
        {% for d in departments %}
        <option value="{{ d.name }}" {% if request.query_params.get('department') == d.name %}selected{% endif %}>
          {{ d.name }}
        </option>
        {% endfor %}
      </select>
    </label>
    <label>
      <i class="fas fa-smile"></i> Sentiment
      <select name="sentiment">
        <option value="">All Sentiments</option>
        {% for s in ["positive","neutral","negative"] %}
        <option value="{{ s }}" {% if request.query_params.get('sentiment') == s %}selected{% endif %}>
          {{ s|capitalize }}
        </option>
        {% endfor %}
      </select>
    </label>
    <label>
      <i class="fas fa-tasks"></i> Status
      <select name="status">
        <option value="">All Status</option>
        <option value="new" {% if request.query_params.get('status') == "new" %}selected{% endif %}>New</option>
        <option value="in_progress" {% if request.query_params.get('status') == "in_progress" %}selected{% endif %}>In Progress</option>
        <option value="resolved" {% if request.query_params.get('status') == "resolved" %}selected{% endif %}>Resolved</option>
      </select>
    </label>
    <div>
      <button type="submit" style="margin-top: 1.8rem;">
        <i class="fas fa-filter"></i> Apply Filters
      </button>
      <a href="/feedback" class="button" style="margin-left: 0.5rem;">
        <i class="fas fa-sync"></i> Clear
      </a>
    </div>
  </form>

  <!-- Stats + Export -->
  <div style="margin: 1rem 0; display: flex; gap: 1rem; align-items: center;">
    <span style="font-weight: 600; color: var(--secondary);">
      <i class="fas fa-chart-bar"></i> {{ feedback|length }} feedback entries found
    </span>
    <button type="button" onclick="exportTableToCSV('feedback.csv')" style="background: var(--success);">
      <i class="fas fa-download"></i> Export CSV
    </button>
  </div>

  <!-- Feedback Table -->
  <div style="overflow-x: auto;">
    <table>
      <thead>
        <tr>
          <th>ID <i class="fas fa-sort"></i></th>
          <th>Created <i class="fas fa-sort"></i></th>
          <th>Parent Info</th>
          <th>Student ID</th>
          <th>Category <i class="fas fa-sort"></i></th>
          <th>Sentiment <i class="fas fa-sort"></i></th>
          <th>Priority <i class="fas fa-sort"></i></th>
          <th>Department <i class="fas fa-sort"></i></th>
          <th>Status <i class="fas fa-sort"></i></th>
          <th>Message</th>
        </tr>
      </thead>
      <tbody>
        {% for f in feedback %}
        <tr>
          <td><strong>#{{ f.id }}</strong></td>
          <td>{{ f.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
          <td>
            <div>{{ f.parent_name }}</div>
            <small style="color: var(--secondary);">{{ f.parent_email }}</small>
          </td>
          <td>{{ f.student_id or "-" }}</td>
          <td>{{ f.category }}</td>
          <td class="sentiment-{{ f.sentiment }}">
            <i class="fas fa-{% if f.sentiment == 'positive' %}smile{% elif f.sentiment == 'negative' %}frown{% else %}meh{% endif %}"></i>
            {{ f.sentiment }}
          </td>
          <td class="priority-{{ f.priority }}">{{ f.priority|upper }}</td>
          <td>{{ f.department }}</td>
          <td>
            <span class="status-badge status-{{ f.status|lower }}">{{ f.status }}</span>
          </td>
          <td class="wrap" title="{{ f.message }}">
            {{ f.message|truncate(100) }}
            {% if f.message|length > 100 %}
            <button type="button"
                    onclick="alert(`{{ f.message|escapejs }}`)" 
                    style="padding: 0.25rem 0.5rem; font-size: 0.75rem; margin-top: 0.5rem;">
              <i class="fas fa-expand"></i> View full
            </button>
            {% endif %}
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="10" style="text-align: center; padding: 2rem; color: var(--secondary);">
            <i class="fas fa-inbox" style="font-size: 3rem; margin-bottom: 1rem; display: block;"></i>
            No feedback found matching your criteria.
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</section>

<!-- Export to CSV Script -->
<script>
function exportTableToCSV(filename) {
  let csv = [];
  const rows = document.querySelectorAll("table tr");
  rows.forEach(row => {
    let cols = row.querySelectorAll("td, th");
    let data = Array.from(cols).map(col => `"${col.innerText.replace(/"/g, '""')}"`);
    csv.push(data.join(","));
  });
  const blob = new Blob([csv.join("\n")], { type: "text/csv" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = filename;
  link.click();
}
</script>
{% endblock %}
